<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribution of Jobs in States</title>
    <script src="./statics/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .chart {
            width: 1000px;
            margin: 70px auto;
        }

        .bar {
            fill: steelblue;
        }

        .bar text {
            fill: white;
            font-size: 12px;
            text-anchor: end;
            alignment-baseline: middle;
        }

        .axis text {
            font-size: 12px;
        }
    </style>
    <link rel="stylesheet" href="./statics/bootstrap-3.4.1-dist/css/bootstrap.min.css">
</head>
<body>
<!--第一个按钮：根据州来绘制工作数量柱状图-->
<div class="chart">
    <button id="chart_jobs" class="btn btn-primary">show jobs in states</button>

<script>
    document.getElementById("chart_jobs").addEventListener("click", function () {

        d3.csv("./jobs_df.csv").then(function (data) {
            let jobData = {};
            // 对某一列进行分组计数
            data.forEach(function (d) {
                var groupKey = d.LocationStates; // 用于分组的列的名称
                if (jobData[groupKey] === undefined) {
                    jobData[groupKey] = 1;
                } else {
                    jobData[groupKey]++;
                }
            });

            // 输出结果
            console.log(jobData);

            // 转换数据为数组
            var dataArray = [];
            for (var key in jobData) {
                dataArray.push({state: key, jobs: jobData[key]});
            }

            // 按照jobs数量从大到小排序
            dataArray.sort(function (a, b) {
                return a.jobs - b.jobs;
            });

            // 设置画布大小
            var margin = {top: 70, right: 90, bottom: 60, left: 90},
                width = 900 - margin.left - margin.right,
                height = 700 - margin.top - margin.bottom;

            // 创建SVG元素
            var svg = d3.select(".chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right + 70)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // 定义比例尺
            var x = d3.scaleLinear().range([0, width]).domain([0, d3.max(dataArray, function (d) {
                return d.jobs;
            })]);
            var y = d3.scaleBand().range([height, 0]).padding(0.1).domain(dataArray.map(function (d) {
                return d.state;
            }));

            y.padding([0.3]);
            // 创建颜色尺度，从浅蓝到深蓝
            const colorScale = d3.scaleSequential(d3.interpolateBlues)
                .domain([d3.min(dataArray, d => d.jobs), d3.max(dataArray, d => d.jobs)]);
            // 添加水平条形图
            svg.selectAll(".bar")
                .data(dataArray)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("width", function (d) {
                    return x(d.jobs);
                })
                .attr("height", y.bandwidth())
                .attr("y", function (d) {
                    return y(d.state);
                })
                .attr("x", 0)
                .style("fill", function (d) {
                    // 根据平均工资应用颜色
                    return colorScale(Math.max(d.jobs, 240));
                })
                .style("opacity", 0.75);
            ;

            // 添加文字标签
            svg.selectAll(".text")
                .data(dataArray)
                .enter().append("text")
                .attr("class", "text")
                .attr("x", function (d) {
                    return x(d.jobs);
                })
                .attr("y", function (d) {
                    return y(d.state) + y.bandwidth() / 2;
                })
                .attr("dx", +10)
                .attr("dy", ".35em")
                .attr("text-anchor", "start")
                .text(function (d) {
                    return (d.jobs / d3.sum(Object.values(jobData)) * 100).toFixed(1) + "% (" + d.jobs + ")";
                })
                .style("font-size", "12px");

            // 添加x轴
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).ticks(10).tickFormat(function (d) {
                    return d;
                }))
                .append("text")
                .attr("x", width / 2)
                .attr("y", 30)
                .attr("dy", "0.71em")
                .attr("fill", "#000")
                .attr("text-anchor", "left")
                .text("Amount of Jobs")
                .style("font-size", "18px");

            // 添加y轴
            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2 + 80)
                .attr("y", -70)
                .attr("dy", "0.71em")
                .attr("fill", "#000")
                .text("Name of States")
                .style("font-size", "18px");

            // 添加标题
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "25px")
                .text("Distribution of Jobs in States");

        });
    })
</script>


<!--第二个按钮：根据岗位类别来绘制平均工资柱状图-->

    <button id="chart_ave_salary_cate" class="btn btn-warning">show average salary of jobs</button>


<script>
    document.getElementById("chart_ave_salary_cate").addEventListener("click", function () {
        d3.csv("./jobs_df.csv").then(function (data) {
            // 对某一列进行计算平均值
            let jobSalary = {};

            // 对某一列进行分组并计算平均值
            const columnToAverage = "p50_salary"; // 替换为要计算平均值的实际列名
            data.forEach(function (d) {
                var groupKey = d.cate; // 用于分组的列的名称

                // 初始化或更新分组数据结构
                if (jobSalary[groupKey] === undefined) {
                    jobSalary[groupKey] = {
                        count: 1,
                        sum: parseFloat(d[columnToAverage])
                    };
                } else {
                    jobSalary[groupKey].count++;
                    jobSalary[groupKey].sum += parseFloat(d[columnToAverage]);
                }
            });

            // 计算并输出每个分组的平均值
            const averagedJobSalary = Object.entries(jobSalary).reduce((result, [key, value]) => {
                result[key] = value.sum / value.count;
                return result;
            }, {});

            console.log(averagedJobSalary);

// 将数据转换为数组
            const data1 = Object.keys(averagedJobSalary).map(key => {
                return {job: key, salary: averagedJobSalary[key]};
            });

// SVG 画布的尺寸和边距
            const margin = {top: 80, right: 100, bottom: 200, left: 70};
            const width = 800 - margin.left - margin.right + 200;
            const height = 500 - margin.top - margin.bottom + 100;

// 创建 SVG 画布
            const svg = d3.select(".chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// 创建 x 轴和 y 轴比例尺
            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .range([height, 0]);

// 域（domain）设置
            x.domain(data1.map(d => d.job));
            y.domain([0, d3.max(data1, d => d.salary)]);

// 创建条形
            svg.selectAll(".bar")
                .data(data1)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.job))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d.salary))
                .attr("height", d => height - y(d.salary))
                .style("fill", (d, i) => d3.schemeCategory10[i % 10]) // 分配有质感的颜色
                .style("opacity", 0.6);

// 在每个条形的上边添加数据标签
            svg.selectAll(".text")
                .data(data1)
                .enter().append("text")
                .attr("x", d => x(d.job) + x.bandwidth() / 2)
                .attr("y", d => y(d.salary) - 5)
                .attr("text-anchor", "middle")
                .text(d => d3.format(".2f")(d.salary));

// 创建 x 轴
            svg.append("g")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end")
                .style("font-size", "14px");

// 创建 y 轴
            svg.append("g")
                .call(d3.axisLeft(y));

// 添加 x 轴标题
            svg.append("text")
                .attr("transform", "translate(" + (width / 2) + " ," + (height + margin.bottom / 2 + 80) + ")")
                .style("text-anchor", "middle")
                .text("Job Categories")
                .style("font-size", "19px");

// 添加 y 轴标题
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("Average Salaries")
                .style("font-size", "19px");

// 添加图表标题
            svg.append("text")
                .attr("transform", "translate(" + (width / 2) + " ," + (-margin.top / 2) + ")")
                .style("text-anchor", "middle")
                .style("font-size", "25px")
                .text("Distribution of Average Salaries in Job Categories");
        });
    })
</script>

<!--第三个按钮：根据州来绘制平均工资柱状图-->

    <button id="chart_ave_salary_state" class="btn btn-danger">show average salary of states</button>

    <script>
        document.getElementById("chart_ave_salary_state").addEventListener("click", function () {
            d3.csv("./jobs_df.csv").then(function (data) {
            // 对某一列进行计算平均值，并找出每个州最常见的岗位类别
            let stateSalaryAndMostCommonCate = {};

// 对某一列进行分组并计算平均值
            const columnToAverage = "p50_salary";
            const columnForMostCommon = "cate"; // 替换为要计算最常见的岗位类别的实际列名
            data.forEach(function (d) {
                var groupKey = d.LocationStates;

                // 初始化或更新分组数据结构
                if (stateSalaryAndMostCommonCate[groupKey] === undefined) {
                    stateSalaryAndMostCommonCate[groupKey] = {
                        count: 1,
                        sum: parseFloat(d[columnToAverage]),
                        most_common_cate: {
                            category: d[columnForMostCommon],
                            count: 1
                        }
                    };
                } else {
                    stateSalaryAndMostCommonCate[groupKey].count++;
                    stateSalaryAndMostCommonCate[groupKey].sum += parseFloat(d[columnToAverage]);

                    // 更新或记录最常见的岗位类别
                    if (!stateSalaryAndMostCommonCate[groupKey].most_common_cate ||
                        stateSalaryAndMostCommonCate[groupKey].most_common_cate.count < 1) {
                        stateSalaryAndMostCommonCate[groupKey].most_common_cate = {
                            category: d[columnForMostCommon],
                            count: 1
                        };
                    } else {
                        if (stateSalaryAndMostCommonCate[groupKey].most_common_cate.category !== d[columnForMostCommon]) {
                            stateSalaryAndMostCommonCate[groupKey].most_common_cate.count++;
                            if (stateSalaryAndMostCommonCate[groupKey].most_common_cate.count > d[columnForMostCommon].count) {
                                stateSalaryAndMostCommonCate[groupKey].most_common_cate.category = d[columnForMostCommon];
                                stateSalaryAndMostCommonCate[groupKey].most_common_cate.count = 1;
                            }
                        } else {
                            stateSalaryAndMostCommonCate[groupKey].most_common_cate.count++;
                        }
                    }
                }
            });

// 计算并输出每个分组的平均值和最常见的岗位类别
            const dataArray = Object.entries(stateSalaryAndMostCommonCate).map(([key, value]) => ({
                state: key,
                average_salary: value.sum / value.count,
                most_num_job_cate: value.most_common_cate.category
            }));


            // 按照jobs数量从大到小排序
            dataArray.sort(function (a, b) {
                return a.average_salary - b.average_salary;
            });

            console.log(dataArray)

            // 设置画布大小
            var margin = {top: 70, right: 90, bottom: 60, left: 90},
                width = 900 - margin.left - margin.right,
                height = 700 - margin.top - margin.bottom;

            // 创建SVG元素
            var svg = d3.select(".chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right + 70)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

            // 定义比例尺
            var x = d3.scaleLinear().range([0, width]).domain([0, d3.max(dataArray, function (d) {
                return d.average_salary;
            })]);
            var y = d3.scaleBand().range([height, 0]).padding(0.1).domain(dataArray.map(function (d) {
                return d.state;
            }));

            y.padding([0.3]);

            // 创建颜色尺度，从浅红到深红
            const colorScale = d3.scaleSequential(d3.interpolateReds)
                .domain([d3.min(dataArray, d => d.average_salary), d3.max(dataArray, d => d.average_salary)]);

            // 添加水平条形图
            svg.selectAll(".bar")
                .data(dataArray)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("width", function (d) {
                    return x(d.average_salary);
                })
                .attr("height", y.bandwidth())
                .attr("y", function (d) {
                    return y(d.state);
                })
                .attr("x", 0)
                .style("fill", function (d) {
                    // 根据平均工资应用颜色
                    return colorScale(d.average_salary);
                })
                .style("opacity", 0.75);

            // 添加文字标签
            svg.selectAll(".text")
                .data(dataArray)
                .enter().append("text")
                .attr("class", "text")
                .attr("x", function (d) {
                    return x(d.average_salary);
                })
                .attr("y", function (d) {
                    return y(d.state) + y.bandwidth() / 2;
                })
                .attr("dx", +10)
                .attr("dy", ".35em")
                .attr("text-anchor", "start")
                .text(function (d) {
                    return d.average_salary.toFixed(2) + "   (" + d.most_num_job_cate + " )";
                })
                .style("font-size", "12px");

            // 添加x轴
            svg.append("g")
                .attr("class", "axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).ticks(10).tickFormat(function (d) {
                    return d;
                }))
                .append("text")
                .attr("x", width / 2)
                .attr("y", 30)
                .attr("dy", "0.71em")
                .attr("fill", "#000")
                .attr("text-anchor", "left")
                .text("Average Salary")
                .style("font-size", "18px");

            // 添加y轴
            svg.append("g")
                .attr("class", "axis")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2 + 80)
                .attr("y", -70)
                .attr("dy", "0.71em")
                .attr("fill", "#000")
                .text("Name of States")
                .style("font-size", "18px");

            // 添加标题
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 0 - (margin.top / 2))
                .attr("text-anchor", "middle")
                .style("font-size", "25px")
                .text("Average Salary of Each State");

        });
        })

    </script>

</div>
</body>
</html>
